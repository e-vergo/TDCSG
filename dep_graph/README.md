# TDCSG Dependency Graph Visualization

Interactive browser-based visualization of the TDCSG Lean 4 formal verification project's dependency graph.

## Quick Start

```bash
cd dep_graph
./serve.sh
# Then open http://localhost:8000/index.html in your browser
```

## Overview

Visualizes **362 declarations** (289 theorems, 67 definitions, 6 misc) and **2076 dependencies** from the TDCSG project using an interactive force-directed graph layout.

## Files

- **`index.html`** - Main page structure
- **`graph-v9.js`** - Cytoscape.js configuration and interactivity logic (Version 13)
- **`styles.css`** - Visual styling with left sidebar panels
- **`graph.json`** - Main dependency graph data (generated by extraction script)
- **`positions.json`** - Optional saved node positions for layout persistence
- **`serve.sh`** - Local development server (avoids CORS issues)

## Features

### Visual Design

**Unified Node Shape**: All nodes rendered as rounded rectangles, dynamically sized to be 10 pixels larger than their text label.

**Color Scheme**:
- **Theorems** (289 nodes): Purple `#945ebd`
- **Definitions** (67 nodes): Teal `#3ab7c4`
- **Main Theorems** (3 nodes): Muted gold `#e0d07a` with double border, 1.3x larger
- **Edges**: Gray with bezier curves and arrows

**Layout**: Force-directed Cose-Bilkent algorithm with generous spacing (idealEdgeLength: 200px, nodeRepulsion: 20000)

### Filter Modes

**All Nodes (362)**: Show complete dependency graph

**Proof Focus (~100)**: Show nodes within N hops of main theorem + high-centrality definitions
- Adjustable distance slider (1-5 hops, default 3)
- Automatically includes definitions with in-degree ≥ 40 (ζ₅, Generator, GG5_induced_IET, etc.)
- Re-runs layout when >50% nodes hidden for cleaner visualization

**Theorems Only (289)**: Show only theorem nodes

**Definitions Only (67)**: Show only definition nodes

**Pruned Tree (~270)**: Show only nodes with dependencies (hides leaf nodes with in-degree 0)
- Automatically keeps main theorems visible
- Hides ~92 "dead end" nodes that aren't used by other proofs
- Useful for focusing on theorems that contribute to other results

### Interactive Controls

**Left Sidebar Panels**:
1. **Graph Controls** (top): Search, filter mode, distance slider, save/reset buttons, stats
2. **Node Info Panel** (bottom): Always visible, updates when clicking nodes

**Search**: Type to filter/highlight nodes by name (case-insensitive, respects current filter)

**Click Node**: Updates info panel with:
- Full declaration name and type
- Lean statement (link to view source on GitHub)
- Documentation/docstring (if available)
- Direct dependencies (clickable list - jumps to that node with animation)
- GitHub source link (line-precise)
- Paper references (if any)

**Hover Node**: Purple overlay highlight

**Drag Node**: Freely reposition for manual layout

**Zoom/Pan**:
- Mouse scroll to zoom
- Click-drag background to pan

**Save Layout**: Downloads `positions.json` with current node positions
- Move downloaded file to `dep_graph/positions.json` for persistence
- Graph automatically loads saved positions on next visit

**Reset View**: Fits all visible nodes in viewport

### Graph Navigation

**Dependency Traversal**: Click dependencies in info panel to jump to that node
- Animates zoom and pan to target node
- Automatically triggers info panel update after 500ms
- Maintains search/filter state

**Distance-Based Filtering**: Explore proof structure by:
1. Select "Proof Focus" mode
2. Adjust distance slider to see N-hop dependencies from main theorem
3. Critical definitions always visible regardless of distance

## Usage

### Recommended: Local Server

```bash
cd dep_graph
./serve.sh
```

Opens local HTTP server on port 8000, avoiding CORS restrictions.

### Alternative: Direct File Access

1. Open `index.html` in modern browser (Chrome, Firefox, Safari)
2. If CORS errors occur, use file picker to manually select `graph.json`
3. For testing: `index.html?test` loads `test_graph.json` (small sample dataset)

## JSON Schema

The visualization consumes `graph.json`:

```json
{
  "nodes": [
    {
      "id": "TDCSG.Namespace.DeclarationName",
      "label": "DeclarationName",
      "type": "theorem|def|lemma|inductive|constructor|recursor",
      "namespace": ["TDCSG", "Namespace"],
      "file": "TDCSG/File.lean",
      "line": 123,
      "docstring": "Documentation text...",
      "paperRefs": ["Theorem 3.2"],
      "isMainTheorem": true|false
    }
  ],
  "edges": [
    {
      "source": "TDCSG.Namespace.Declaration1",
      "target": "TDCSG.Namespace.Declaration2"
    }
  ]
}
```

**Required Fields**:
- `nodes[].id`: Unique identifier
- `nodes[].label`: Display name
- `nodes[].type`: Declaration type
- `nodes[].file`: Source file path
- `nodes[].line`: Line number
- `edges[].source`: Source node ID
- `edges[].target`: Target node ID

**Optional Fields**:
- `nodes[].docstring`: Documentation string
- `nodes[].paperRefs`: Array of paper references
- `nodes[].isMainTheorem`: Boolean flag for main results

## Technology Stack

- **Cytoscape.js 3.28.1**: Core graph visualization
- **Cose-Bilkent 4.1.0**: Force-directed layout algorithm
- **Vanilla JavaScript**: No build step required
- **Modern CSS**: Flexbox layouts, semi-transparent panels

## Architecture

### Layout Algorithm

1. **Initial Load**: Checks for `positions.json`
   - If exists: Uses preset layout with saved positions
   - If missing: Runs Cose-Bilkent force-directed algorithm (1000 iterations)

2. **Filter Re-layout**: When >50% nodes hidden, re-runs layout with:
   - Reduced iterations (500) for faster animation
   - Same spacing parameters for consistency
   - 1000ms animation duration

### Distance Computation

Backward BFS from main theorem (`GG5_infinite_at_critical_radius`):
- Traverses reverse edges (target → source)
- Computes shortest path distance from each node to main theorem
- Stores `distanceFromMain` in node data
- Used for "Proof Focus" filtering

### Node Visibility

Uses Cytoscape's native `.show()` and `.hide()` methods (not CSS classes):
- More performant than CSS display toggling
- Properly updates graph layout
- Maintains edge visibility rules

## Browser Compatibility

**Tested**:
- Chrome 90+
- Firefox 88+
- Safari 14+

**Requirements**:
- ES6+ support (arrow functions, const/let, template literals)
- Modern CSS (flexbox, calc(), rgba())
- Canvas API (for Cytoscape rendering)

## Development

### Making Changes

1. Edit `graph-v9.js`, `index.html`, or `styles.css`
2. Refresh browser (hard refresh: Cmd+Shift+R / Ctrl+Shift+F5)
3. No build step required

### Testing with Sample Data

```bash
# Open test graph (5 nodes, 5 edges)
open http://localhost:8000/index.html?test
```

### Version History

- **v13**: Added statement display in info panel, added pruned tree filter mode
- **v12**: Unified rounded rectangles, fixed left sidebar info panel, working filters
- **v11**: Fixed info panel at bottom
- **v10**: Dynamic node sizing based on label length
- **v9**: Custom user colors and sizes
- **v8**: Visual improvements (larger nodes, text backgrounds)
- **v7**: Initial filtering implementation
- **v6**: Force-directed layout with spacing parameters

## Troubleshooting

**Error Loading Graph**
- Ensure `graph.json` exists in `dep_graph/` directory
- Validate JSON syntax (use `jq . graph.json` or online validator)
- Check browser console for detailed error messages

**Nodes Don't Appear**
- Verify `graph.json` schema matches expected format
- Check for JavaScript errors in console
- Try clearing browser cache and hard refresh

**Layout Looks Wrong**
- Delete `positions.json` to regenerate from force-directed algorithm
- Increase `numIter` in layout config for better convergence
- Adjust spacing parameters (idealEdgeLength, nodeRepulsion, gravity)

**Filters Don't Work**
- Ensure using Cytoscape's `.hide()/.show()` methods, not CSS classes
- Check filter logic in `applyFilter()` function
- Verify distance computation completed (check console logs)

**GitHub Links 404**
- Verify repository URL in `graph-v9.js` (line 298)
- Ensure file paths in `graph.json` match repository structure
- Check that `data.file` and `data.line` are correctly populated

**Info Panel Overlaps Graph**
- Adjust `top` offset in `styles.css` `#info-panel` (default: 320px)
- Ensure controls box height hasn't changed significantly
- Use browser dev tools to inspect element positioning

## Future Enhancements

- [ ] Export graph as SVG/PNG
- [ ] Minimap for large graph navigation
- [ ] Fisheye zoom on hover
- [ ] Shortest path highlighting between two nodes
- [ ] Collapsible namespace groups
- [ ] Timeline view of theorem dependency evolution
- [ ] Integration with Lean LSP for live updates
